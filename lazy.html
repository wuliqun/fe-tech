<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Lazy load</title>
  <style>
    .imgs img{
      width: 100%;
      /* height: 100%; */
      vertical-align: middle;
      margin-bottom: 20px;
    }

    .imgs{
      height: 200vh;
    }

    .imgs .img{
      width: 350px;
      height: 350px;
    }

  </style>
</head>
<body>
  <div class="imgs">
    <div class="img"><img lazy="https://qumi-1304843926.cos.ap-shanghai.myqcloud.com/images/common/64abb997d07aa.png" alt=""></div>
    <div class="img"><img lazy="https://qumi-1304843926.cos.ap-shanghai.myqcloud.com/images/common/64abb9675ed82.png" alt=""></div>
    <div class="img"><img lazy="https://qumi-1304843926.cos.ap-shanghai.myqcloud.com/images/common/64a7cba9e9be8.png" alt=""></div>
    <div class="img"><img lazy="https://qumi-1304843926.cos.ap-shanghai.myqcloud.com/images/common/64a389b16ab01.png" alt=""></div>
    <div class="img"><img lazy="https://qumi-1304843926.cos.ap-shanghai.myqcloud.com/images/common/649bb752d25a8.png" alt=""></div>
  </div>
</body>
<script src="./throttle.js"></script>
<script>
  const lazyImgs = document.querySelectorAll('img[lazy]');
  // 添加占位图片
  lazyImgs.forEach(img=>{
    const src = img.getAttribute('lazy');
    img.src = src + '?imageMogr2/format/webp/thumbnail/20x'
  });

  if(window.IntersectionObserver){
    // #region IntersectionObserver
    // 通过 isIntersecting 属性判断元素与视口是否相交
    const observer = new IntersectionObserver((entries, observer) => {
      entries.forEach((entry) => {
        if(entry.isIntersecting){
          const img = entry.target;
          const src = img.getAttribute('lazy');
          if(src !== img.src){
            img.src = src;
            observer.unobserve(img);
          }
        }
      });
    })

    lazyImgs.forEach((img) => {
      observer.observe(img);
    });
    // #endregion
  }else{
    // #region 滚动监听
    const showImg = throttle(()=>{
      const {availHeight:height,availWidth:width} = window.screen;
      let flag = false;
      lazyImgs.forEach(img=>{
        const src = img.getAttribute('lazy');
        if(src !== img.src){
          flag = true;
          const rect = img.getBoundingClientRect();
          // 出现在视口内
          if(!(rect.bottom < 0 || rect.top > height || rect.left > width || rect.right < 0)){
            img.src = src;
          }
        }
      })
      if(!flag){
        window.removeEventListener('scroll',showImg);
      }
    })

    window.addEventListener('load',showImg);
    // scroll  resize  orientationchange
    window.addEventListener('scroll',showImg);
    // #endregion
  }
</script>
</html>